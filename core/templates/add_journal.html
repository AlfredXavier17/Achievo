{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <a href="{% url 'goal_detail' goal.id %}" class="btn btn-outline-light mb-4">‚Üê Back to Goal</a>

  <h2 class="mb-3">üìù New Journal Entry for <strong>{{ goal.title }}</strong></h2>

  <form method="POST" action="{% url 'add_journal' goal.id %}">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="btn btn-primary mt-3" id="save-button">Save Entry</button>
  </form>

  <!-- ‚úÖ Template Selector -->
  <div id="templateSelector" class="mt-5">
    <h3 class="mb-3">Choose a Template:</h3>

    <!-- Default Template -->
    <div class="template-block">
      <div class="d-flex align-items-center justify-content-between py-2">
        <a href="#" class="template-link text-decoration-none text-light"
           data-content="{{ default_template.content|escapejs }}">
          <i class="fa-regular fa-file-lines me-2"></i>{{ default_template.title }}
        </a>
      </div>
    </div>

    <!-- User Templates -->
    {% for template in templates %}
    <div class="template-block">
      <div class="d-flex align-items-center justify-content-between py-2">
        <a href="#" class="template-link text-decoration-none text-light"
           data-content="{{ template.content|escapejs }}">
          <i class="fa-regular fa-file-lines me-2"></i>{{ template.title }}
        </a>
        <div class="d-flex align-items-center gap-2">
          <a href="{% url 'edit_prompt_template' template.id %}" class="text-light">
            <i class="fa-regular fa-pen-to-square"></i>
          </a>
          <a href="#" class="text-danger" data-bs-toggle="modal" data-bs-target="#deleteTemplateModal-{{ template.id }}">
            <i class="fa-solid fa-trash"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteTemplateModal-{{ template.id }}" tabindex="-1"
         aria-labelledby="deleteTemplateModalLabel-{{ template.id }}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light border border-danger">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteTemplateModalLabel-{{ template.id }}">Delete Template?</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete the template "{{ template.title|escape }}"?
          </div>
          <div class="modal-footer">
            <form method="POST" action="{% url 'delete_prompt_template' template.id %}?goal_id={{ goal.id }}">
              {% csrf_token %}
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">Yes, delete</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}

    <div class="text-center mt-4">
      <a href="{% url 'create_template' %}" class="btn btn-primary">+ New Template</a>
    </div>
  </div>
</div>

<!-- ‚úÖ JS to handle template click + hiding -->
<script>
  const contentBox = document.getElementById('id_content');
  const templateLinks = document.querySelectorAll('.template-link');
  const templateSelector = document.getElementById('templateSelector');

  if (contentBox && templateSelector) {
    // Hide when user types
    contentBox.addEventListener('input', () => {
      templateSelector.classList.add('d-none');
    });

    // Template click behavior
    templateLinks.forEach(link => {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        const content = this.dataset.content.replace(/\\u000A/g, '\n\n\n\n');
        contentBox.value = content;
        contentBox.focus();
        templateSelector.classList.add('d-none');
      });
    });
  }
</script>

<!-- ‚úÖ Clean styling -->
<style>
  .template-link {
    font-size: 1.2rem;
    display: block;
  }

  .template-link i,
  .d-flex.align-items-center.gap-2 a i {
    font-size: 1.2rem;
  }

  #templateSelector {
    border-top: 1px solid #555;
    margin-top: 2rem;
    padding-top: 1rem;
  }

  .template-block {
    background-color: #1a1a1a;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }

  #save-button {
    z-index: 10;
    position: relative;
  }
</style>
{% endblock %}
